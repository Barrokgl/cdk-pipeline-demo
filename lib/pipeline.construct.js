"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PipelineConstruct = void 0;
const core_1 = require("@aws-cdk/core");
const aws_codepipeline_1 = require("@aws-cdk/aws-codepipeline");
const aws_codepipeline_actions_1 = require("@aws-cdk/aws-codepipeline-actions");
const pipelines_1 = require("@aws-cdk/pipelines");
const aws_s3_1 = require("@aws-cdk/aws-s3");
const aws_cloudtrail_1 = require("@aws-cdk/aws-cloudtrail");
const aws_codebuild_1 = require("@aws-cdk/aws-codebuild");
class PipelineConstruct {
    constructor(scope, props) {
        this.preDeployActions = [];
        this.actions = [];
        this.scope = scope;
        this.id = props.id;
        this.sourceArtifact = new aws_codepipeline_1.Artifact();
        this.cloudAssemblyArtifact = new aws_codepipeline_1.Artifact();
        this.synthAction = pipelines_1.SimpleSynthAction.standardNpmSynth({
            sourceArtifact: this.sourceArtifact,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            buildCommand: 'npm run build',
            environmentVariables: {
                'STAGE': {
                    type: aws_codebuild_1.BuildEnvironmentVariableType.PLAINTEXT,
                    value: props.stage
                }
            }
        });
        return this;
    }
    static of(scope, props) {
        return new PipelineConstruct(scope, props);
    }
    addS3Source({ bucketName, bucketPath }) {
        const bucket = aws_s3_1.Bucket.fromBucketName(this.scope, bucketName, bucketName);
        const trail = new aws_cloudtrail_1.Trail(this.scope, `${this.id}-cloud-trail`);
        trail.addS3EventSelector([{ bucket, objectPrefix: bucket.arnForObjects('*') }], {
            readWriteType: aws_cloudtrail_1.ReadWriteType.WRITE_ONLY,
        });
        // bucket.onCloudTrailPutObject(`${this.id}-event-rule`, {
        //     paths: [bucketPath]
        // });
        this.sourceAction = new aws_codepipeline_actions_1.S3SourceAction({
            actionName: 'S3Source',
            bucketKey: bucketPath,
            bucket: bucket,
            output: this.sourceArtifact,
            trigger: aws_codepipeline_actions_1.S3Trigger.EVENTS,
        });
        return this;
    }
    addGithubRepository({ secretName, owner, repo, branch = 'develop' }) {
        this.sourceAction = new aws_codepipeline_actions_1.GitHubSourceAction({
            actionName: 'GithubSource',
            output: this.sourceArtifact,
            oauthToken: core_1.SecretValue.secretsManager(secretName),
            owner,
            repo,
            branch,
        });
        return this;
    }
    addPreDeployAction(fun) {
        this.preDeployActions.push(fun);
        return this;
    }
    addStage(stage) {
        this.stage = stage;
        return this;
    }
    addAction(fun) {
        this.actions.push(fun);
        return this;
    }
    addInvokeLambdaAction(lambda, params) {
        this.addAction((_, nextRunOrder) => new aws_codepipeline_actions_1.LambdaInvokeAction({
            lambda: lambda,
            actionName: `InvokeLambda`,
            userParameters: params,
            runOrder: nextRunOrder
        }));
        return this;
    }
    build() {
        this.pipeline = new pipelines_1.CdkPipeline(this.scope, this.id, {
            pipelineName: this.id,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            sourceAction: this.sourceAction,
            synthAction: this.synthAction,
        });
        if (this.preDeployActions.length > 0) {
            const preDeploy = this.pipeline.addStage('PreDeploy');
            this.preDeployActions.forEach(f => {
                preDeploy.addActions(f(this.pipeline, preDeploy.nextSequentialRunOrder()));
            });
        }
        if (this.stage !== undefined) {
            const appStage = this.pipeline.addApplicationStage(this.stage);
            appStage.nextSequentialRunOrder();
            this.actions.forEach(f => {
                appStage.addActions(f(this.pipeline, appStage.nextSequentialRunOrder()));
            });
        }
        return this;
    }
}
exports.PipelineConstruct = PipelineConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUuY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGlwZWxpbmUuY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdDQUE0RDtBQUM1RCxnRUFBNEQ7QUFDNUQsZ0ZBQW9IO0FBQ3BILGtEQUFrRTtBQUVsRSw0Q0FBdUM7QUFDdkMsNERBQTZEO0FBQzdELDBEQUFvRTtBQW1CcEUsTUFBYSxpQkFBaUI7SUFtQjFCLFlBQW9CLEtBQWdCLEVBQUUsS0FBNkI7UUFUM0QscUJBQWdCLEdBQW9FLEVBQUUsQ0FBQztRQUN2RixZQUFPLEdBQW9FLEVBQUUsQ0FBQztRQVNsRixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLDJCQUFRLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSwyQkFBUSxFQUFFLENBQUM7UUFFNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyw2QkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQztZQUNsRCxjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWM7WUFDbkMscUJBQXFCLEVBQUUsSUFBSSxDQUFDLHFCQUFxQjtZQUNqRCxZQUFZLEVBQUUsZUFBZTtZQUM3QixvQkFBb0IsRUFBRTtnQkFDbEIsT0FBTyxFQUFFO29CQUNMLElBQUksRUFBRSw0Q0FBNEIsQ0FBQyxTQUFTO29CQUM1QyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7aUJBQ3JCO2FBQ0o7U0FDSixDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBdEJELE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBZ0IsRUFBRSxLQUE2QjtRQUNyRCxPQUFPLElBQUksaUJBQWlCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFzQkQsV0FBVyxDQUFDLEVBQUMsVUFBVSxFQUFFLFVBQVUsRUFBVztRQUMxQyxNQUFNLE1BQU0sR0FBRyxlQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBRXhFLE1BQU0sS0FBSyxHQUFHLElBQUksc0JBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFFOUQsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUMsRUFBQyxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUMsQ0FBQyxFQUFFO1lBQzFFLGFBQWEsRUFBRSw4QkFBYSxDQUFDLFVBQVU7U0FDMUMsQ0FBQyxDQUFDO1FBRUgsMERBQTBEO1FBQzFELDBCQUEwQjtRQUMxQixNQUFNO1FBRU4sSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLHlDQUFjLENBQUM7WUFDbkMsVUFBVSxFQUFFLFVBQVU7WUFDdEIsU0FBUyxFQUFFLFVBQVU7WUFDckIsTUFBTSxFQUFFLE1BQU07WUFDZCxNQUFNLEVBQUUsSUFBSSxDQUFDLGNBQWM7WUFDM0IsT0FBTyxFQUFFLG9DQUFTLENBQUMsTUFBTTtTQUM1QixDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsbUJBQW1CLENBQUMsRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEdBQUcsU0FBUyxFQUFvQjtRQUNoRixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksNkNBQWtCLENBQUM7WUFDdkMsVUFBVSxFQUFFLGNBQWM7WUFDMUIsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjO1lBQzNCLFVBQVUsRUFBRSxrQkFBVyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUM7WUFDbEQsS0FBSztZQUNMLElBQUk7WUFDSixNQUFNO1NBQ1QsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELGtCQUFrQixDQUFDLEdBQTZEO1FBQzVFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELFFBQVEsQ0FBQyxLQUFZO1FBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxTQUFTLENBQUMsR0FBNkQ7UUFDbkUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdkIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELHFCQUFxQixDQUFDLE1BQWlCLEVBQUUsTUFBaUM7UUFFdEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksNkNBQWtCLENBQUM7WUFDdkQsTUFBTSxFQUFFLE1BQU07WUFDZCxVQUFVLEVBQUUsY0FBYztZQUMxQixjQUFjLEVBQUUsTUFBTTtZQUN0QixRQUFRLEVBQUUsWUFBWTtTQUN6QixDQUFDLENBQUMsQ0FBQztRQUNKLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxLQUFLO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLHVCQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2pELFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRTtZQUNyQixxQkFBcUIsRUFBRSxJQUFJLENBQUMscUJBQXFCO1lBQ2pELFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7U0FDaEMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNsQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUM5QixTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMvRSxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsSUFBSSxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUMxQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvRCxRQUFRLENBQUMsc0JBQXNCLEVBQUUsQ0FBQTtZQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDckIsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLENBQUE7WUFDNUUsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQTdIRCw4Q0E2SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbnN0cnVjdCwgU2VjcmV0VmFsdWUsIFN0YWdlfSBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0IHtBcnRpZmFjdCwgSUFjdGlvbn0gZnJvbSBcIkBhd3MtY2RrL2F3cy1jb2RlcGlwZWxpbmVcIjtcbmltcG9ydCB7R2l0SHViU291cmNlQWN0aW9uLCBMYW1iZGFJbnZva2VBY3Rpb24sIFMzU291cmNlQWN0aW9uLCBTM1RyaWdnZXJ9IGZyb20gXCJAYXdzLWNkay9hd3MtY29kZXBpcGVsaW5lLWFjdGlvbnNcIjtcbmltcG9ydCB7Q2RrUGlwZWxpbmUsIFNpbXBsZVN5bnRoQWN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvcGlwZWxpbmVzXCI7XG5pbXBvcnQge0lGdW5jdGlvbn0gZnJvbSBcIkBhd3MtY2RrL2F3cy1sYW1iZGFcIjtcbmltcG9ydCB7QnVja2V0fSBmcm9tIFwiQGF3cy1jZGsvYXdzLXMzXCI7XG5pbXBvcnQge1JlYWRXcml0ZVR5cGUsIFRyYWlsfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWNsb3VkdHJhaWxcIjtcbmltcG9ydCB7QnVpbGRFbnZpcm9ubWVudFZhcmlhYmxlVHlwZX0gZnJvbSBcIkBhd3MtY2RrL2F3cy1jb2RlYnVpbGRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQaXBlbGluZUNvbnN0cnVjdFByb3BzIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHN0YWdlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBHaXRodWJBY3Rpb25Qcm9wcyB7XG4gICAgc2VjcmV0TmFtZTogc3RyaW5nO1xuICAgIG93bmVyOiBzdHJpbmc7XG4gICAgcmVwbzogc3RyaW5nO1xuICAgIGJyYW5jaD86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFMzU291cmNlIHtcbiAgICBidWNrZXROYW1lOiBzdHJpbmc7XG4gICAgYnVja2V0UGF0aDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUGlwZWxpbmVDb25zdHJ1Y3Qge1xuICAgIHJlYWRvbmx5IHNvdXJjZUFydGlmYWN0OiBBcnRpZmFjdDtcbiAgICByZWFkb25seSBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IEFydGlmYWN0O1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBzY29wZTogQ29uc3RydWN0O1xuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIHBpcGVsaW5lOiBDZGtQaXBlbGluZTtcbiAgICBwcml2YXRlIHN0YWdlOiBTdGFnZTtcblxuICAgIHByaXZhdGUgcHJlRGVwbG95QWN0aW9uczogQXJyYXk8KHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24+ID0gW107XG4gICAgcHJpdmF0ZSBhY3Rpb25zOiBBcnJheTwocGlwZWxpbmU6IENka1BpcGVsaW5lLCBuZXh0UnVuT3JkZXI6IG51bWJlcikgPT4gSUFjdGlvbj4gPSBbXTtcbiAgICBwcml2YXRlIHNvdXJjZUFjdGlvbjogSUFjdGlvbjtcbiAgICBwcml2YXRlIHN5bnRoQWN0aW9uOiBJQWN0aW9uO1xuXG4gICAgc3RhdGljIG9mKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBQaXBlbGluZUNvbnN0cnVjdFByb3BzKSB7XG4gICAgICAgIHJldHVybiBuZXcgUGlwZWxpbmVDb25zdHJ1Y3Qoc2NvcGUsIHByb3BzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBQaXBlbGluZUNvbnN0cnVjdFByb3BzKSB7XG4gICAgICAgIHRoaXMuc2NvcGUgPSBzY29wZTtcbiAgICAgICAgdGhpcy5pZCA9IHByb3BzLmlkO1xuICAgICAgICB0aGlzLnNvdXJjZUFydGlmYWN0ID0gbmV3IEFydGlmYWN0KCk7XG4gICAgICAgIHRoaXMuY2xvdWRBc3NlbWJseUFydGlmYWN0ID0gbmV3IEFydGlmYWN0KCk7XG5cbiAgICAgICAgdGhpcy5zeW50aEFjdGlvbiA9IFNpbXBsZVN5bnRoQWN0aW9uLnN0YW5kYXJkTnBtU3ludGgoe1xuICAgICAgICAgICAgc291cmNlQXJ0aWZhY3Q6IHRoaXMuc291cmNlQXJ0aWZhY3QsXG4gICAgICAgICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IHRoaXMuY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgICAgICAgICAgYnVpbGRDb21tYW5kOiAnbnBtIHJ1biBidWlsZCcsXG4gICAgICAgICAgICBlbnZpcm9ubWVudFZhcmlhYmxlczoge1xuICAgICAgICAgICAgICAgICdTVEFHRSc6IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogQnVpbGRFbnZpcm9ubWVudFZhcmlhYmxlVHlwZS5QTEFJTlRFWFQsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcm9wcy5zdGFnZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZFMzU291cmNlKHtidWNrZXROYW1lLCBidWNrZXRQYXRofTogUzNTb3VyY2UpIHtcbiAgICAgICAgY29uc3QgYnVja2V0ID0gQnVja2V0LmZyb21CdWNrZXROYW1lKHRoaXMuc2NvcGUsIGJ1Y2tldE5hbWUsIGJ1Y2tldE5hbWUpXG5cbiAgICAgICAgY29uc3QgdHJhaWwgPSBuZXcgVHJhaWwodGhpcy5zY29wZSwgYCR7dGhpcy5pZH0tY2xvdWQtdHJhaWxgKTtcblxuICAgICAgICB0cmFpbC5hZGRTM0V2ZW50U2VsZWN0b3IoW3tidWNrZXQsIG9iamVjdFByZWZpeDogYnVja2V0LmFybkZvck9iamVjdHMoJyonKX1dLCB7XG4gICAgICAgICAgICByZWFkV3JpdGVUeXBlOiBSZWFkV3JpdGVUeXBlLldSSVRFX09OTFksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGJ1Y2tldC5vbkNsb3VkVHJhaWxQdXRPYmplY3QoYCR7dGhpcy5pZH0tZXZlbnQtcnVsZWAsIHtcbiAgICAgICAgLy8gICAgIHBhdGhzOiBbYnVja2V0UGF0aF1cbiAgICAgICAgLy8gfSk7XG5cbiAgICAgICAgdGhpcy5zb3VyY2VBY3Rpb24gPSBuZXcgUzNTb3VyY2VBY3Rpb24oe1xuICAgICAgICAgICAgYWN0aW9uTmFtZTogJ1MzU291cmNlJyxcbiAgICAgICAgICAgIGJ1Y2tldEtleTogYnVja2V0UGF0aCxcbiAgICAgICAgICAgIGJ1Y2tldDogYnVja2V0LFxuICAgICAgICAgICAgb3V0cHV0OiB0aGlzLnNvdXJjZUFydGlmYWN0LFxuICAgICAgICAgICAgdHJpZ2dlcjogUzNUcmlnZ2VyLkVWRU5UUyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZEdpdGh1YlJlcG9zaXRvcnkoe3NlY3JldE5hbWUsIG93bmVyLCByZXBvLCBicmFuY2ggPSAnZGV2ZWxvcCd9OiBHaXRodWJBY3Rpb25Qcm9wcykge1xuICAgICAgICB0aGlzLnNvdXJjZUFjdGlvbiA9IG5ldyBHaXRIdWJTb3VyY2VBY3Rpb24oe1xuICAgICAgICAgICAgYWN0aW9uTmFtZTogJ0dpdGh1YlNvdXJjZScsXG4gICAgICAgICAgICBvdXRwdXQ6IHRoaXMuc291cmNlQXJ0aWZhY3QsXG4gICAgICAgICAgICBvYXV0aFRva2VuOiBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcihzZWNyZXROYW1lKSxcbiAgICAgICAgICAgIG93bmVyLFxuICAgICAgICAgICAgcmVwbyxcbiAgICAgICAgICAgIGJyYW5jaCxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZFByZURlcGxveUFjdGlvbihmdW46IChwaXBlbGluZTogQ2RrUGlwZWxpbmUsIG5leHRSdW5PcmRlcjogbnVtYmVyKSA9PiBJQWN0aW9uKSB7XG4gICAgICAgIHRoaXMucHJlRGVwbG95QWN0aW9ucy5wdXNoKGZ1bik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZFN0YWdlKHN0YWdlOiBTdGFnZSkge1xuICAgICAgICB0aGlzLnN0YWdlID0gc3RhZ2U7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZEFjdGlvbihmdW46IChwaXBlbGluZTogQ2RrUGlwZWxpbmUsIG5leHRSdW5PcmRlcjogbnVtYmVyKSA9PiBJQWN0aW9uKSB7XG4gICAgICAgIHRoaXMuYWN0aW9ucy5wdXNoKGZ1bik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZEludm9rZUxhbWJkYUFjdGlvbihsYW1iZGE6IElGdW5jdGlvbiwgcGFyYW1zPzoge1trZXk6IHN0cmluZ106IHVua25vd259KSB7XG5cbiAgICAgICAgdGhpcy5hZGRBY3Rpb24oKF8sIG5leHRSdW5PcmRlcikgPT4gbmV3IExhbWJkYUludm9rZUFjdGlvbih7XG4gICAgICAgICAgICBsYW1iZGE6IGxhbWJkYSxcbiAgICAgICAgICAgIGFjdGlvbk5hbWU6IGBJbnZva2VMYW1iZGFgLFxuICAgICAgICAgICAgdXNlclBhcmFtZXRlcnM6IHBhcmFtcyxcbiAgICAgICAgICAgIHJ1bk9yZGVyOiBuZXh0UnVuT3JkZXJcbiAgICAgICAgfSkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZCgpIHtcbiAgICAgICAgdGhpcy5waXBlbGluZSA9IG5ldyBDZGtQaXBlbGluZSh0aGlzLnNjb3BlLCB0aGlzLmlkLCB7XG4gICAgICAgICAgICBwaXBlbGluZU5hbWU6IHRoaXMuaWQsXG4gICAgICAgICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IHRoaXMuY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgICAgICAgICAgc291cmNlQWN0aW9uOiB0aGlzLnNvdXJjZUFjdGlvbixcbiAgICAgICAgICAgIHN5bnRoQWN0aW9uOiB0aGlzLnN5bnRoQWN0aW9uLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5wcmVEZXBsb3lBY3Rpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHByZURlcGxveSA9IHRoaXMucGlwZWxpbmUuYWRkU3RhZ2UoJ1ByZURlcGxveScpO1xuICAgICAgICAgICAgdGhpcy5wcmVEZXBsb3lBY3Rpb25zLmZvckVhY2goZiA9PiB7XG4gICAgICAgICAgICAgICAgcHJlRGVwbG95LmFkZEFjdGlvbnMoZih0aGlzLnBpcGVsaW5lLCBwcmVEZXBsb3kubmV4dFNlcXVlbnRpYWxSdW5PcmRlcigpKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnN0YWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGFwcFN0YWdlID0gdGhpcy5waXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKHRoaXMuc3RhZ2UpO1xuICAgICAgICAgICAgYXBwU3RhZ2UubmV4dFNlcXVlbnRpYWxSdW5PcmRlcigpXG4gICAgICAgICAgICB0aGlzLmFjdGlvbnMuZm9yRWFjaChmID0+IHtcbiAgICAgICAgICAgICAgICBhcHBTdGFnZS5hZGRBY3Rpb25zKGYodGhpcy5waXBlbGluZSwgYXBwU3RhZ2UubmV4dFNlcXVlbnRpYWxSdW5PcmRlcigpKSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxufVxuIl19