"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PipelineConstruct = void 0;
const core_1 = require("@aws-cdk/core");
const aws_codepipeline_1 = require("@aws-cdk/aws-codepipeline");
const aws_codepipeline_actions_1 = require("@aws-cdk/aws-codepipeline-actions");
const pipelines_1 = require("@aws-cdk/pipelines");
const aws_s3_1 = require("@aws-cdk/aws-s3");
class PipelineConstruct {
    constructor(scope, props) {
        this.preDeployActions = [];
        this.actions = [];
        this.scope = scope;
        this.id = props.id;
        this.sourceArtifact = new aws_codepipeline_1.Artifact();
        this.cloudAssemblyArtifact = new aws_codepipeline_1.Artifact();
        this.synthAction = pipelines_1.SimpleSynthAction.standardNpmSynth({
            sourceArtifact: this.sourceArtifact,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            buildCommand: 'npm run build'
        });
        return this;
    }
    static of(scope, props) {
        return new PipelineConstruct(scope, props);
    }
    addS3Source({ bucketName, bucketPath }) {
        // const s3policy = new PolicyStatement({
        //     effect: Effect.ALLOW,
        //     actions: [
        //         's3:*',
        //     ],
        //     resources: ['*'],
        // });
        // this.role.addToPrincipalPolicy(s3policy);
        const bucket = aws_s3_1.Bucket.fromBucketName(this.scope, bucketName, bucketName);
        // bucket.grantRead(this.role);
        this.sourceAction = new aws_codepipeline_actions_1.S3SourceAction({
            actionName: 'S3Source',
            bucketKey: bucketPath,
            bucket: bucket,
            output: this.sourceArtifact,
            trigger: aws_codepipeline_actions_1.S3Trigger.POLL,
        });
        return this;
    }
    addGithubRepository({ secretName, owner, repo, branch = 'develop' }) {
        this.sourceAction = new aws_codepipeline_actions_1.GitHubSourceAction({
            actionName: 'GithubSource',
            output: this.sourceArtifact,
            oauthToken: core_1.SecretValue.secretsManager(secretName),
            owner,
            repo,
            branch,
        });
        return this;
    }
    addPreDeployAction(fun) {
        this.preDeployActions.push(fun);
        return this;
    }
    addStage(stage) {
        this.stage = stage;
        return this;
    }
    addAction(fun) {
        this.actions.push(fun);
        return this;
    }
    addInvokeLambdaAction(lambda, params) {
        this.addAction((_, nextRunOrder) => new aws_codepipeline_actions_1.LambdaInvokeAction({
            lambda: lambda,
            actionName: `InvokeLambda`,
            userParameters: params,
            runOrder: nextRunOrder
        }));
        return this;
    }
    build() {
        this.pipeline = new pipelines_1.CdkPipeline(this.scope, this.id, {
            pipelineName: this.id,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            sourceAction: this.sourceAction,
            synthAction: this.synthAction,
        });
        if (this.preDeployActions.length > 0) {
            const preDeploy = this.pipeline.addStage('PreDeploy');
            this.preDeployActions.forEach(f => {
                preDeploy.addActions(f(this.pipeline, preDeploy.nextSequentialRunOrder()));
            });
        }
        if (this.stage !== undefined) {
            const appStage = this.pipeline.addApplicationStage(this.stage);
            appStage.nextSequentialRunOrder();
            this.actions.forEach(f => {
                appStage.addActions(f(this.pipeline, appStage.nextSequentialRunOrder()));
            });
        }
        return this;
    }
}
exports.PipelineConstruct = PipelineConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUuY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGlwZWxpbmUuY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdDQUE0RDtBQUM1RCxnRUFBNEQ7QUFDNUQsZ0ZBQW9IO0FBQ3BILGtEQUFrRTtBQUVsRSw0Q0FBdUM7QUFvQnZDLE1BQWEsaUJBQWlCO0lBbUIxQixZQUFvQixLQUFnQixFQUFFLEtBQTZCO1FBVDNELHFCQUFnQixHQUFvRSxFQUFFLENBQUM7UUFDdkYsWUFBTyxHQUFvRSxFQUFFLENBQUM7UUFTbEYsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSwyQkFBUSxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksMkJBQVEsRUFBRSxDQUFDO1FBRTVDLElBQUksQ0FBQyxXQUFXLEdBQUcsNkJBQWlCLENBQUMsZ0JBQWdCLENBQUM7WUFDbEQsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjO1lBQ25DLHFCQUFxQixFQUFFLElBQUksQ0FBQyxxQkFBcUI7WUFDakQsWUFBWSxFQUFFLGVBQWU7U0FDaEMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQWhCRCxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQWdCLEVBQUUsS0FBNkI7UUFDckQsT0FBTyxJQUFJLGlCQUFpQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBZ0JELFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxVQUFVLEVBQVc7UUFDMUMseUNBQXlDO1FBQ3pDLDRCQUE0QjtRQUM1QixpQkFBaUI7UUFDakIsa0JBQWtCO1FBQ2xCLFNBQVM7UUFDVCx3QkFBd0I7UUFDeEIsTUFBTTtRQUNOLDRDQUE0QztR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LFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFBO1lBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNyQixRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUM1RSxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBeEhELDhDQXdIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29uc3RydWN0LCBTZWNyZXRWYWx1ZSwgU3RhZ2V9IGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQge0FydGlmYWN0LCBJQWN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZVwiO1xuaW1wb3J0IHtHaXRIdWJTb3VyY2VBY3Rpb24sIExhbWJkYUludm9rZUFjdGlvbiwgUzNTb3VyY2VBY3Rpb24sIFMzVHJpZ2dlcn0gZnJvbSBcIkBhd3MtY2RrL2F3cy1jb2RlcGlwZWxpbmUtYWN0aW9uc1wiO1xuaW1wb3J0IHtDZGtQaXBlbGluZSwgU2ltcGxlU3ludGhBY3Rpb259IGZyb20gXCJAYXdzLWNkay9waXBlbGluZXNcIjtcbmltcG9ydCB7SUZ1bmN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHtCdWNrZXR9IGZyb20gXCJAYXdzLWNkay9hd3MtczNcIjtcbmltcG9ydCB7RWZmZWN0LCBJUm9sZSwgUG9saWN5U3RhdGVtZW50LCBSb2xlLCBTZXJ2aWNlUHJpbmNpcGFsfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWlhbVwiO1xuaW1wb3J0IHtTZXJ2aWNlUHJpbmNpcGFsc30gZnJvbSBcImNkay1jb25zdGFudHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQaXBlbGluZUNvbnN0cnVjdFByb3BzIHtcbiAgICBpZDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgR2l0aHViQWN0aW9uUHJvcHMge1xuICAgIHNlY3JldE5hbWU6IHN0cmluZztcbiAgICBvd25lcjogc3RyaW5nO1xuICAgIHJlcG86IHN0cmluZztcbiAgICBicmFuY2g/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBTM1NvdXJjZSB7XG4gICAgYnVja2V0TmFtZTogc3RyaW5nO1xuICAgIGJ1Y2tldFBhdGg6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFBpcGVsaW5lQ29uc3RydWN0IHtcbiAgICByZWFkb25seSBzb3VyY2VBcnRpZmFjdDogQXJ0aWZhY3Q7XG4gICAgcmVhZG9ubHkgY2xvdWRBc3NlbWJseUFydGlmYWN0OiBBcnRpZmFjdDtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2NvcGU6IENvbnN0cnVjdDtcbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBwaXBlbGluZTogQ2RrUGlwZWxpbmU7XG4gICAgcHJpdmF0ZSBzdGFnZTogU3RhZ2U7XG5cbiAgICBwcml2YXRlIHByZURlcGxveUFjdGlvbnM6IEFycmF5PChwaXBlbGluZTogQ2RrUGlwZWxpbmUsIG5leHRSdW5PcmRlcjogbnVtYmVyKSA9PiBJQWN0aW9uPiA9IFtdO1xuICAgIHByaXZhdGUgYWN0aW9uczogQXJyYXk8KHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24+ID0gW107XG4gICAgcHJpdmF0ZSBzb3VyY2VBY3Rpb246IElBY3Rpb247XG4gICAgcHJpdmF0ZSBzeW50aEFjdGlvbjogSUFjdGlvbjtcblxuICAgIHN0YXRpYyBvZihzY29wZTogQ29uc3RydWN0LCBwcm9wczogUGlwZWxpbmVDb25zdHJ1Y3RQcm9wcykge1xuICAgICAgICByZXR1cm4gbmV3IFBpcGVsaW5lQ29uc3RydWN0KHNjb3BlLCBwcm9wcyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBwcm9wczogUGlwZWxpbmVDb25zdHJ1Y3RQcm9wcykge1xuICAgICAgICB0aGlzLnNjb3BlID0gc2NvcGU7XG4gICAgICAgIHRoaXMuaWQgPSBwcm9wcy5pZDtcbiAgICAgICAgdGhpcy5zb3VyY2VBcnRpZmFjdCA9IG5ldyBBcnRpZmFjdCgpO1xuICAgICAgICB0aGlzLmNsb3VkQXNzZW1ibHlBcnRpZmFjdCA9IG5ldyBBcnRpZmFjdCgpO1xuXG4gICAgICAgIHRoaXMuc3ludGhBY3Rpb24gPSBTaW1wbGVTeW50aEFjdGlvbi5zdGFuZGFyZE5wbVN5bnRoKHtcbiAgICAgICAgICAgIHNvdXJjZUFydGlmYWN0OiB0aGlzLnNvdXJjZUFydGlmYWN0LFxuICAgICAgICAgICAgY2xvdWRBc3NlbWJseUFydGlmYWN0OiB0aGlzLmNsb3VkQXNzZW1ibHlBcnRpZmFjdCxcbiAgICAgICAgICAgIGJ1aWxkQ29tbWFuZDogJ25wbSBydW4gYnVpbGQnXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhZGRTM1NvdXJjZSh7YnVja2V0TmFtZSwgYnVja2V0UGF0aH06IFMzU291cmNlKSB7XG4gICAgICAgIC8vIGNvbnN0IHMzcG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIC8vICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgLy8gICAgIGFjdGlvbnM6IFtcbiAgICAgICAgLy8gICAgICAgICAnczM6KicsXG4gICAgICAgIC8vICAgICBdLFxuICAgICAgICAvLyAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgLy8gfSk7XG4gICAgICAgIC8vIHRoaXMucm9sZS5hZGRUb1ByaW5jaXBhbFBvbGljeShzM3BvbGljeSk7XG5cbiAgICAgICAgY29uc3QgYnVja2V0ID0gQnVja2V0LmZyb21CdWNrZXROYW1lKHRoaXMuc2NvcGUsIGJ1Y2tldE5hbWUsIGJ1Y2tldE5hbWUpXG4gICAgICAgIC8vIGJ1Y2tldC5ncmFudFJlYWQodGhpcy5yb2xlKTtcblxuICAgICAgICB0aGlzLnNvdXJjZUFjdGlvbiA9IG5ldyBTM1NvdXJjZUFjdGlvbih7XG4gICAgICAgICAgICBhY3Rpb25OYW1lOiAnUzNTb3VyY2UnLFxuICAgICAgICAgICAgYnVja2V0S2V5OiBidWNrZXRQYXRoLFxuICAgICAgICAgICAgYnVja2V0OiBidWNrZXQsXG4gICAgICAgICAgICBvdXRwdXQ6IHRoaXMuc291cmNlQXJ0aWZhY3QsXG4gICAgICAgICAgICB0cmlnZ2VyOiBTM1RyaWdnZXIuUE9MTCxcbiAgICAgICAgICAgIC8vIHJvbGU6IHRoaXMucm9sZVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkR2l0aHViUmVwb3NpdG9yeSh7c2VjcmV0TmFtZSwgb3duZXIsIHJlcG8sIGJyYW5jaCA9ICdkZXZlbG9wJ306IEdpdGh1YkFjdGlvblByb3BzKSB7XG4gICAgICAgIHRoaXMuc291cmNlQWN0aW9uID0gbmV3IEdpdEh1YlNvdXJjZUFjdGlvbih7XG4gICAgICAgICAgICBhY3Rpb25OYW1lOiAnR2l0aHViU291cmNlJyxcbiAgICAgICAgICAgIG91dHB1dDogdGhpcy5zb3VyY2VBcnRpZmFjdCxcbiAgICAgICAgICAgIG9hdXRoVG9rZW46IFNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKHNlY3JldE5hbWUpLFxuICAgICAgICAgICAgb3duZXIsXG4gICAgICAgICAgICByZXBvLFxuICAgICAgICAgICAgYnJhbmNoLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkUHJlRGVwbG95QWN0aW9uKGZ1bjogKHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24pIHtcbiAgICAgICAgdGhpcy5wcmVEZXBsb3lBY3Rpb25zLnB1c2goZnVuKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkU3RhZ2Uoc3RhZ2U6IFN0YWdlKSB7XG4gICAgICAgIHRoaXMuc3RhZ2UgPSBzdGFnZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkQWN0aW9uKGZ1bjogKHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24pIHtcbiAgICAgICAgdGhpcy5hY3Rpb25zLnB1c2goZnVuKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkSW52b2tlTGFtYmRhQWN0aW9uKGxhbWJkYTogSUZ1bmN0aW9uLCBwYXJhbXM/OiB7W2tleTogc3RyaW5nXTogdW5rbm93bn0pIHtcblxuICAgICAgICB0aGlzLmFkZEFjdGlvbigoXywgbmV4dFJ1bk9yZGVyKSA9PiBuZXcgTGFtYmRhSW52b2tlQWN0aW9uKHtcbiAgICAgICAgICAgIGxhbWJkYTogbGFtYmRhLFxuICAgICAgICAgICAgYWN0aW9uTmFtZTogYEludm9rZUxhbWJkYWAsXG4gICAgICAgICAgICB1c2VyUGFyYW1ldGVyczogcGFyYW1zLFxuICAgICAgICAgICAgcnVuT3JkZXI6IG5leHRSdW5PcmRlclxuICAgICAgICB9KSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGJ1aWxkKCkge1xuICAgICAgICB0aGlzLnBpcGVsaW5lID0gbmV3IENka1BpcGVsaW5lKHRoaXMuc2NvcGUsIHRoaXMuaWQsIHtcbiAgICAgICAgICAgIHBpcGVsaW5lTmFtZTogdGhpcy5pZCxcbiAgICAgICAgICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdDogdGhpcy5jbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICAgICAgICBzb3VyY2VBY3Rpb246IHRoaXMuc291cmNlQWN0aW9uLFxuICAgICAgICAgICAgc3ludGhBY3Rpb246IHRoaXMuc3ludGhBY3Rpb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLnByZURlcGxveUFjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgcHJlRGVwbG95ID0gdGhpcy5waXBlbGluZS5hZGRTdGFnZSgnUHJlRGVwbG95Jyk7XG4gICAgICAgICAgICB0aGlzLnByZURlcGxveUFjdGlvbnMuZm9yRWFjaChmID0+IHtcbiAgICAgICAgICAgICAgICBwcmVEZXBsb3kuYWRkQWN0aW9ucyhmKHRoaXMucGlwZWxpbmUsIHByZURlcGxveS5uZXh0U2VxdWVudGlhbFJ1bk9yZGVyKCkpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhZ2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY29uc3QgYXBwU3RhZ2UgPSB0aGlzLnBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UodGhpcy5zdGFnZSk7XG4gICAgICAgICAgICBhcHBTdGFnZS5uZXh0U2VxdWVudGlhbFJ1bk9yZGVyKClcbiAgICAgICAgICAgIHRoaXMuYWN0aW9ucy5mb3JFYWNoKGYgPT4ge1xuICAgICAgICAgICAgICAgIGFwcFN0YWdlLmFkZEFjdGlvbnMoZih0aGlzLnBpcGVsaW5lLCBhcHBTdGFnZS5uZXh0U2VxdWVudGlhbFJ1bk9yZGVyKCkpKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG4iXX0=