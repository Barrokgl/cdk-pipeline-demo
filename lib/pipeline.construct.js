"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PipelineConstruct = void 0;
const core_1 = require("@aws-cdk/core");
const aws_codepipeline_1 = require("@aws-cdk/aws-codepipeline");
const aws_codepipeline_actions_1 = require("@aws-cdk/aws-codepipeline-actions");
const pipelines_1 = require("@aws-cdk/pipelines");
class PipelineConstruct {
    constructor(scope, props) {
        this.preDeployActions = [];
        this.actions = [];
        this.scope = scope;
        this.id = props.id;
        this.sourceArtifact = new aws_codepipeline_1.Artifact();
        this.cloudAssemblyArtifact = new aws_codepipeline_1.Artifact();
        this.synthAction = pipelines_1.SimpleSynthAction.standardNpmSynth({
            sourceArtifact: this.sourceArtifact,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            buildCommand: 'npm run build'
        });
        return this;
    }
    static of(scope, props) {
        return new PipelineConstruct(scope, props);
    }
    addGithubRepository({ secretName, owner, repo, branch = 'develop' }) {
        this.sourceAction = new aws_codepipeline_actions_1.GitHubSourceAction({
            actionName: 'GithubSource',
            output: this.sourceArtifact,
            oauthToken: core_1.SecretValue.secretsManager(secretName),
            owner,
            repo,
            branch,
        });
        return this;
    }
    addPreDeployAction(fun) {
        this.preDeployActions.push(fun);
        return this;
    }
    addStage(stage) {
        this.stage = stage;
        return this;
    }
    addAction(fun) {
        this.actions.push(fun);
        return this;
    }
    addInvokeLambdaAction(lambda, params) {
        this.addAction((_, nextRunOrder) => new aws_codepipeline_actions_1.LambdaInvokeAction({
            lambda: lambda,
            actionName: `InvokeLambda`,
            userParameters: params,
            runOrder: nextRunOrder
        }));
        return this;
    }
    build() {
        this.pipeline = new pipelines_1.CdkPipeline(this.scope, this.id, {
            pipelineName: this.id,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            sourceAction: this.sourceAction,
            synthAction: this.synthAction,
        });
        if (this.preDeployActions.length > 0) {
            const preDeploy = this.pipeline.addStage('PreDeploy');
            this.preDeployActions.forEach(f => {
                preDeploy.addActions(f(this.pipeline, preDeploy.nextSequentialRunOrder()));
            });
        }
        if (this.stage !== undefined) {
            const appStage = this.pipeline.addApplicationStage(this.stage);
            appStage.nextSequentialRunOrder();
            this.actions.forEach(f => {
                appStage.addActions(f(this.pipeline, appStage.nextSequentialRunOrder()));
            });
        }
        return this;
    }
}
exports.PipelineConstruct = PipelineConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUuY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGlwZWxpbmUuY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdDQUE0RDtBQUM1RCxnRUFBNEQ7QUFDNUQsZ0ZBQWlHO0FBQ2pHLGtEQUFrRTtBQWVsRSxNQUFhLGlCQUFpQjtJQW1CMUIsWUFBb0IsS0FBZ0IsRUFBRSxLQUE2QjtRQVQzRCxxQkFBZ0IsR0FBb0UsRUFBRSxDQUFDO1FBQ3ZGLFlBQU8sR0FBb0UsRUFBRSxDQUFDO1FBU2xGLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksMkJBQVEsRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLDJCQUFRLEVBQUUsQ0FBQztRQUU1QyxJQUFJLENBQUMsV0FBVyxHQUFHLDZCQUFpQixDQUFDLGdCQUFnQixDQUFDO1lBQ2xELGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztZQUNuQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMscUJBQXFCO1lBQ2pELFlBQVksRUFBRSxlQUFlO1NBQ2hDLENBQUMsQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFoQkQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFnQixFQUFFLEtBQTZCO1FBQ3JELE9BQU8sSUFBSSxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQWdCRCxtQkFBbUIsQ0FBQyxFQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sR0FBRyxTQUFTLEVBQW9CO1FBQ2hGLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSw2Q0FBa0IsQ0FBQztZQUN2QyxVQUFVLEVBQUUsY0FBYztZQUMxQixNQUFNLEVBQUUsSUFBSSxDQUFDLGNBQWM7WUFDM0IsVUFBVSxFQUFFLGtCQUFXLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQztZQUNsRCxLQUFLO1lBQ0wsSUFBSTtZQUNKLE1BQU07U0FDVCxDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsa0JBQWtCLENBQUMsR0FBNkQ7UUFDNUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsUUFBUSxDQUFDLEtBQVk7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELFNBQVMsQ0FBQyxHQUE2RDtRQUNuRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQscUJBQXFCLENBQUMsTUFBaUIsRUFBRSxNQUFpQztRQUV0RSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxFQUFFLENBQUMsSUFBSSw2Q0FBa0IsQ0FBQztZQUN2RCxNQUFNLEVBQUUsTUFBTTtZQUNkLFVBQVUsRUFBRSxjQUFjO1lBQzFCLGNBQWMsRUFBRSxNQUFNO1lBQ3RCLFFBQVEsRUFBRSxZQUFZO1NBQ3pCLENBQUMsQ0FBQyxDQUFDO1FBQ0osT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELEtBQUs7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksdUJBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDakQsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFO1lBQ3JCLHFCQUFxQixFQUFFLElBQUksQ0FBQyxxQkFBcUI7WUFDakQsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1lBQy9CLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztTQUNoQyxDQUFDLENBQUM7UUFFSCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzlCLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQy9FLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQzFCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9ELFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFBO1lBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNyQixRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUM1RSxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBaEdELDhDQWdHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29uc3RydWN0LCBTZWNyZXRWYWx1ZSwgU3RhZ2V9IGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQge0FydGlmYWN0LCBJQWN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZVwiO1xuaW1wb3J0IHtBY3Rpb24sIEdpdEh1YlNvdXJjZUFjdGlvbiwgTGFtYmRhSW52b2tlQWN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZS1hY3Rpb25zXCI7XG5pbXBvcnQge0Nka1BpcGVsaW5lLCBTaW1wbGVTeW50aEFjdGlvbn0gZnJvbSBcIkBhd3MtY2RrL3BpcGVsaW5lc1wiO1xuaW1wb3J0IHtJRnVuY3Rpb259IGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5pbXBvcnQge3BpcGVsaW5lfSBmcm9tIFwic3RyZWFtXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGlwZWxpbmVDb25zdHJ1Y3RQcm9wcyB7XG4gICAgaWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEdpdGh1YkFjdGlvblByb3BzIHtcbiAgICBzZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgb3duZXI6IHN0cmluZztcbiAgICByZXBvOiBzdHJpbmc7XG4gICAgYnJhbmNoPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUGlwZWxpbmVDb25zdHJ1Y3Qge1xuICAgIHJlYWRvbmx5IHNvdXJjZUFydGlmYWN0OiBBcnRpZmFjdDtcbiAgICByZWFkb25seSBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IEFydGlmYWN0O1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBzY29wZTogQ29uc3RydWN0O1xuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIHBpcGVsaW5lOiBDZGtQaXBlbGluZTtcbiAgICBwcml2YXRlIHN0YWdlOiBTdGFnZTtcblxuICAgIHByaXZhdGUgcHJlRGVwbG95QWN0aW9uczogQXJyYXk8KHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24+ID0gW107XG4gICAgcHJpdmF0ZSBhY3Rpb25zOiBBcnJheTwocGlwZWxpbmU6IENka1BpcGVsaW5lLCBuZXh0UnVuT3JkZXI6IG51bWJlcikgPT4gSUFjdGlvbj4gPSBbXTtcbiAgICBwcml2YXRlIHNvdXJjZUFjdGlvbjogSUFjdGlvbjtcbiAgICBwcml2YXRlIHN5bnRoQWN0aW9uOiBJQWN0aW9uO1xuXG4gICAgc3RhdGljIG9mKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBQaXBlbGluZUNvbnN0cnVjdFByb3BzKSB7XG4gICAgICAgIHJldHVybiBuZXcgUGlwZWxpbmVDb25zdHJ1Y3Qoc2NvcGUsIHByb3BzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBQaXBlbGluZUNvbnN0cnVjdFByb3BzKSB7XG4gICAgICAgIHRoaXMuc2NvcGUgPSBzY29wZTtcbiAgICAgICAgdGhpcy5pZCA9IHByb3BzLmlkO1xuICAgICAgICB0aGlzLnNvdXJjZUFydGlmYWN0ID0gbmV3IEFydGlmYWN0KCk7XG4gICAgICAgIHRoaXMuY2xvdWRBc3NlbWJseUFydGlmYWN0ID0gbmV3IEFydGlmYWN0KCk7XG5cbiAgICAgICAgdGhpcy5zeW50aEFjdGlvbiA9IFNpbXBsZVN5bnRoQWN0aW9uLnN0YW5kYXJkTnBtU3ludGgoe1xuICAgICAgICAgICAgc291cmNlQXJ0aWZhY3Q6IHRoaXMuc291cmNlQXJ0aWZhY3QsXG4gICAgICAgICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IHRoaXMuY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgICAgICAgICAgYnVpbGRDb21tYW5kOiAnbnBtIHJ1biBidWlsZCdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZEdpdGh1YlJlcG9zaXRvcnkoe3NlY3JldE5hbWUsIG93bmVyLCByZXBvLCBicmFuY2ggPSAnZGV2ZWxvcCd9OiBHaXRodWJBY3Rpb25Qcm9wcykge1xuICAgICAgICB0aGlzLnNvdXJjZUFjdGlvbiA9IG5ldyBHaXRIdWJTb3VyY2VBY3Rpb24oe1xuICAgICAgICAgICAgYWN0aW9uTmFtZTogJ0dpdGh1YlNvdXJjZScsXG4gICAgICAgICAgICBvdXRwdXQ6IHRoaXMuc291cmNlQXJ0aWZhY3QsXG4gICAgICAgICAgICBvYXV0aFRva2VuOiBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcihzZWNyZXROYW1lKSxcbiAgICAgICAgICAgIG93bmVyLFxuICAgICAgICAgICAgcmVwbyxcbiAgICAgICAgICAgIGJyYW5jaCxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZFByZURlcGxveUFjdGlvbihmdW46IChwaXBlbGluZTogQ2RrUGlwZWxpbmUsIG5leHRSdW5PcmRlcjogbnVtYmVyKSA9PiBJQWN0aW9uKSB7XG4gICAgICAgIHRoaXMucHJlRGVwbG95QWN0aW9ucy5wdXNoKGZ1bik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZFN0YWdlKHN0YWdlOiBTdGFnZSkge1xuICAgICAgICB0aGlzLnN0YWdlID0gc3RhZ2U7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZEFjdGlvbihmdW46IChwaXBlbGluZTogQ2RrUGlwZWxpbmUsIG5leHRSdW5PcmRlcjogbnVtYmVyKSA9PiBJQWN0aW9uKSB7XG4gICAgICAgIHRoaXMuYWN0aW9ucy5wdXNoKGZ1bik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZEludm9rZUxhbWJkYUFjdGlvbihsYW1iZGE6IElGdW5jdGlvbiwgcGFyYW1zPzoge1trZXk6IHN0cmluZ106IHVua25vd259KSB7XG5cbiAgICAgICAgdGhpcy5hZGRBY3Rpb24oKF8sIG5leHRSdW5PcmRlcikgPT4gbmV3IExhbWJkYUludm9rZUFjdGlvbih7XG4gICAgICAgICAgICBsYW1iZGE6IGxhbWJkYSxcbiAgICAgICAgICAgIGFjdGlvbk5hbWU6IGBJbnZva2VMYW1iZGFgLFxuICAgICAgICAgICAgdXNlclBhcmFtZXRlcnM6IHBhcmFtcyxcbiAgICAgICAgICAgIHJ1bk9yZGVyOiBuZXh0UnVuT3JkZXJcbiAgICAgICAgfSkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZCgpIHtcbiAgICAgICAgdGhpcy5waXBlbGluZSA9IG5ldyBDZGtQaXBlbGluZSh0aGlzLnNjb3BlLCB0aGlzLmlkLCB7XG4gICAgICAgICAgICBwaXBlbGluZU5hbWU6IHRoaXMuaWQsXG4gICAgICAgICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IHRoaXMuY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgICAgICAgICAgc291cmNlQWN0aW9uOiB0aGlzLnNvdXJjZUFjdGlvbixcbiAgICAgICAgICAgIHN5bnRoQWN0aW9uOiB0aGlzLnN5bnRoQWN0aW9uLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5wcmVEZXBsb3lBY3Rpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHByZURlcGxveSA9IHRoaXMucGlwZWxpbmUuYWRkU3RhZ2UoJ1ByZURlcGxveScpO1xuICAgICAgICAgICAgdGhpcy5wcmVEZXBsb3lBY3Rpb25zLmZvckVhY2goZiA9PiB7XG4gICAgICAgICAgICAgICAgcHJlRGVwbG95LmFkZEFjdGlvbnMoZih0aGlzLnBpcGVsaW5lLCBwcmVEZXBsb3kubmV4dFNlcXVlbnRpYWxSdW5PcmRlcigpKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnN0YWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGFwcFN0YWdlID0gdGhpcy5waXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKHRoaXMuc3RhZ2UpO1xuICAgICAgICAgICAgYXBwU3RhZ2UubmV4dFNlcXVlbnRpYWxSdW5PcmRlcigpXG4gICAgICAgICAgICB0aGlzLmFjdGlvbnMuZm9yRWFjaChmID0+IHtcbiAgICAgICAgICAgICAgICBhcHBTdGFnZS5hZGRBY3Rpb25zKGYodGhpcy5waXBlbGluZSwgYXBwU3RhZ2UubmV4dFNlcXVlbnRpYWxSdW5PcmRlcigpKSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxufVxuIl19