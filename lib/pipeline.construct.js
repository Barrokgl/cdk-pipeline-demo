"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PipelineConstruct = void 0;
const core_1 = require("@aws-cdk/core");
const aws_codepipeline_1 = require("@aws-cdk/aws-codepipeline");
const aws_codepipeline_actions_1 = require("@aws-cdk/aws-codepipeline-actions");
const pipelines_1 = require("@aws-cdk/pipelines");
const aws_s3_1 = require("@aws-cdk/aws-s3");
const aws_cloudtrail_1 = require("@aws-cdk/aws-cloudtrail");
const aws_codebuild_1 = require("@aws-cdk/aws-codebuild");
class PipelineConstruct {
    constructor(scope, props) {
        this.preDeployActions = [];
        this.actions = [];
        this.scope = scope;
        this.id = props.id;
        this.sourceArtifact = new aws_codepipeline_1.Artifact();
        this.cloudAssemblyArtifact = new aws_codepipeline_1.Artifact();
        this.synthAction = pipelines_1.SimpleSynthAction.standardNpmSynth({
            sourceArtifact: this.sourceArtifact,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            buildCommand: 'npm run build',
            environmentVariables: {
                'STAGE': {
                    type: aws_codebuild_1.BuildEnvironmentVariableType.PLAINTEXT,
                    value: props.stage
                }
            }
        });
        return this;
    }
    static of(scope, props) {
        return new PipelineConstruct(scope, props);
    }
    addS3Source({ bucketName, bucketPath }) {
        const bucket = aws_s3_1.Bucket.fromBucketName(this.scope, bucketName, bucketName);
        const trail = new aws_cloudtrail_1.Trail(this.scope, `${this.id}-cloud-trail`);
        trail.addS3EventSelector([{ bucket, objectPrefix: bucket.arnForObjects(bucketPath) }], {
            readWriteType: aws_cloudtrail_1.ReadWriteType.WRITE_ONLY,
        });
        bucket.onCloudTrailPutObject(`${this.id}-event-rule`, {
            paths: [bucketPath]
        });
        this.sourceAction = new aws_codepipeline_actions_1.S3SourceAction({
            actionName: 'S3Source',
            bucketKey: bucketPath,
            bucket: bucket,
            output: this.sourceArtifact,
            trigger: aws_codepipeline_actions_1.S3Trigger.EVENTS,
        });
        return this;
    }
    addGithubRepository({ secretName, owner, repo, branch = 'develop' }) {
        this.sourceAction = new aws_codepipeline_actions_1.GitHubSourceAction({
            actionName: 'GithubSource',
            output: this.sourceArtifact,
            oauthToken: core_1.SecretValue.secretsManager(secretName),
            owner,
            repo,
            branch,
        });
        return this;
    }
    addPreDeployAction(fun) {
        this.preDeployActions.push(fun);
        return this;
    }
    addStage(stage) {
        this.stage = stage;
        return this;
    }
    addAction(fun) {
        this.actions.push(fun);
        return this;
    }
    addInvokeLambdaAction(lambda, params) {
        this.addAction((_, nextRunOrder) => new aws_codepipeline_actions_1.LambdaInvokeAction({
            lambda: lambda,
            actionName: `InvokeLambda`,
            userParameters: params,
            runOrder: nextRunOrder
        }));
        return this;
    }
    build() {
        this.pipeline = new pipelines_1.CdkPipeline(this.scope, this.id, {
            pipelineName: this.id,
            cloudAssemblyArtifact: this.cloudAssemblyArtifact,
            sourceAction: this.sourceAction,
            synthAction: this.synthAction,
        });
        if (this.preDeployActions.length > 0) {
            const preDeploy = this.pipeline.addStage('PreDeploy');
            this.preDeployActions.forEach(f => {
                preDeploy.addActions(f(this.pipeline, preDeploy.nextSequentialRunOrder()));
            });
        }
        if (this.stage !== undefined) {
            const appStage = this.pipeline.addApplicationStage(this.stage);
            appStage.nextSequentialRunOrder();
            this.actions.forEach(f => {
                appStage.addActions(f(this.pipeline, appStage.nextSequentialRunOrder()));
            });
        }
        return this;
    }
}
exports.PipelineConstruct = PipelineConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUuY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGlwZWxpbmUuY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdDQUE0RDtBQUM1RCxnRUFBNEQ7QUFDNUQsZ0ZBQW9IO0FBQ3BILGtEQUFrRTtBQUVsRSw0Q0FBdUM7QUFDdkMsNERBQTZEO0FBQzdELDBEQUFvRTtBQW1CcEUsTUFBYSxpQkFBaUI7SUFtQjFCLFlBQW9CLEtBQWdCLEVBQUUsS0FBNkI7UUFUM0QscUJBQWdCLEdBQW9FLEVBQUUsQ0FBQztRQUN2RixZQUFPLEdBQW9FLEVBQUUsQ0FBQztRQVNsRixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLDJCQUFRLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSwyQkFBUSxFQUFFLENBQUM7UUFFNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyw2QkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQztZQUNsRCxjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWM7WUFDbkMscUJBQXFCLEVBQUUsSUFBSSxDQUFDLHFCQUFxQjtZQUNqRCxZQUFZLEVBQUUsZUFBZTtZQUM3QixvQkFBb0IsRUFBRTtnQkFDbEIsT0FBTyxFQUFFO29CQUNMLElBQUksRUFBRSw0Q0FBNEIsQ0FBQyxTQUFTO29CQUM1QyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7aUJBQ3JCO2FBQ0o7U0FDSixDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBdEJELE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBZ0IsRUFBRSxLQUE2QjtRQUNyRCxPQUFPLElBQUksaUJBQWlCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFz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Q0FBQyxFQUFFO1lBQ2xDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzlCLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQy9FLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQzFCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9ELFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFBO1lBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNyQixRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUM1RSxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBM0hELDhDQTJIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29uc3RydWN0LCBTZWNyZXRWYWx1ZSwgU3RhZ2V9IGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQge0FydGlmYWN0LCBJQWN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZVwiO1xuaW1wb3J0IHtHaXRIdWJTb3VyY2VBY3Rpb24sIExhbWJkYUludm9rZUFjdGlvbiwgUzNTb3VyY2VBY3Rpb24sIFMzVHJpZ2dlcn0gZnJvbSBcIkBhd3MtY2RrL2F3cy1jb2RlcGlwZWxpbmUtYWN0aW9uc1wiO1xuaW1wb3J0IHtDZGtQaXBlbGluZSwgU2ltcGxlU3ludGhBY3Rpb259IGZyb20gXCJAYXdzLWNkay9waXBlbGluZXNcIjtcbmltcG9ydCB7SUZ1bmN0aW9ufSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHtCdWNrZXR9IGZyb20gXCJAYXdzLWNkay9hd3MtczNcIjtcbmltcG9ydCB7UmVhZFdyaXRlVHlwZSwgVHJhaWx9IGZyb20gXCJAYXdzLWNkay9hd3MtY2xvdWR0cmFpbFwiO1xuaW1wb3J0IHtCdWlsZEVudmlyb25tZW50VmFyaWFibGVUeXBlfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWNvZGVidWlsZFwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFBpcGVsaW5lQ29uc3RydWN0UHJvcHMge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgc3RhZ2U6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEdpdGh1YkFjdGlvblByb3BzIHtcbiAgICBzZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgb3duZXI6IHN0cmluZztcbiAgICByZXBvOiBzdHJpbmc7XG4gICAgYnJhbmNoPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgUzNTb3VyY2Uge1xuICAgIGJ1Y2tldE5hbWU6IHN0cmluZztcbiAgICBidWNrZXRQYXRoOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBQaXBlbGluZUNvbnN0cnVjdCB7XG4gICAgcmVhZG9ubHkgc291cmNlQXJ0aWZhY3Q6IEFydGlmYWN0O1xuICAgIHJlYWRvbmx5IGNsb3VkQXNzZW1ibHlBcnRpZmFjdDogQXJ0aWZhY3Q7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHNjb3BlOiBDb25zdHJ1Y3Q7XG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcblxuICAgIHByaXZhdGUgcGlwZWxpbmU6IENka1BpcGVsaW5lO1xuICAgIHByaXZhdGUgc3RhZ2U6IFN0YWdlO1xuXG4gICAgcHJpdmF0ZSBwcmVEZXBsb3lBY3Rpb25zOiBBcnJheTwocGlwZWxpbmU6IENka1BpcGVsaW5lLCBuZXh0UnVuT3JkZXI6IG51bWJlcikgPT4gSUFjdGlvbj4gPSBbXTtcbiAgICBwcml2YXRlIGFjdGlvbnM6IEFycmF5PChwaXBlbGluZTogQ2RrUGlwZWxpbmUsIG5leHRSdW5PcmRlcjogbnVtYmVyKSA9PiBJQWN0aW9uPiA9IFtdO1xuICAgIHByaXZhdGUgc291cmNlQWN0aW9uOiBJQWN0aW9uO1xuICAgIHByaXZhdGUgc3ludGhBY3Rpb246IElBY3Rpb247XG5cbiAgICBzdGF0aWMgb2Yoc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IFBpcGVsaW5lQ29uc3RydWN0UHJvcHMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQaXBlbGluZUNvbnN0cnVjdChzY29wZSwgcHJvcHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IFBpcGVsaW5lQ29uc3RydWN0UHJvcHMpIHtcbiAgICAgICAgdGhpcy5zY29wZSA9IHNjb3BlO1xuICAgICAgICB0aGlzLmlkID0gcHJvcHMuaWQ7XG4gICAgICAgIHRoaXMuc291cmNlQXJ0aWZhY3QgPSBuZXcgQXJ0aWZhY3QoKTtcbiAgICAgICAgdGhpcy5jbG91ZEFzc2VtYmx5QXJ0aWZhY3QgPSBuZXcgQXJ0aWZhY3QoKTtcblxuICAgICAgICB0aGlzLnN5bnRoQWN0aW9uID0gU2ltcGxlU3ludGhBY3Rpb24uc3RhbmRhcmROcG1TeW50aCh7XG4gICAgICAgICAgICBzb3VyY2VBcnRpZmFjdDogdGhpcy5zb3VyY2VBcnRpZmFjdCxcbiAgICAgICAgICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdDogdGhpcy5jbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICAgICAgICBidWlsZENvbW1hbmQ6ICducG0gcnVuIGJ1aWxkJyxcbiAgICAgICAgICAgIGVudmlyb25tZW50VmFyaWFibGVzOiB7XG4gICAgICAgICAgICAgICAgJ1NUQUdFJzoge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiBCdWlsZEVudmlyb25tZW50VmFyaWFibGVUeXBlLlBMQUlOVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByb3BzLnN0YWdlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkUzNTb3VyY2Uoe2J1Y2tldE5hbWUsIGJ1Y2tldFBhdGh9OiBTM1NvdXJjZSkge1xuICAgICAgICBjb25zdCBidWNrZXQgPSBCdWNrZXQuZnJvbUJ1Y2tldE5hbWUodGhpcy5zY29wZSwgYnVja2V0TmFtZSwgYnVja2V0TmFtZSlcblxuICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyBUcmFpbCh0aGlzLnNjb3BlLCBgJHt0aGlzLmlkfS1jbG91ZC10cmFpbGApO1xuICAgICAgICB0cmFpbC5hZGRTM0V2ZW50U2VsZWN0b3IoW3tidWNrZXQsIG9iamVjdFByZWZpeDogYnVja2V0LmFybkZvck9iamVjdHMoYnVja2V0UGF0aCl9XSwge1xuICAgICAgICAgICAgcmVhZFdyaXRlVHlwZTogUmVhZFdyaXRlVHlwZS5XUklURV9PTkxZLFxuICAgICAgICB9KTtcblxuICAgICAgICBidWNrZXQub25DbG91ZFRyYWlsUHV0T2JqZWN0KGAke3RoaXMuaWR9LWV2ZW50LXJ1bGVgLCB7XG4gICAgICAgICAgICBwYXRoczogW2J1Y2tldFBhdGhdXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNvdXJjZUFjdGlvbiA9IG5ldyBTM1NvdXJjZUFjdGlvbih7XG4gICAgICAgICAgICBhY3Rpb25OYW1lOiAnUzNTb3VyY2UnLFxuICAgICAgICAgICAgYnVja2V0S2V5OiBidWNrZXRQYXRoLFxuICAgICAgICAgICAgYnVja2V0OiBidWNrZXQsXG4gICAgICAgICAgICBvdXRwdXQ6IHRoaXMuc291cmNlQXJ0aWZhY3QsXG4gICAgICAgICAgICB0cmlnZ2VyOiBTM1RyaWdnZXIuRVZFTlRTLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkR2l0aHViUmVwb3NpdG9yeSh7c2VjcmV0TmFtZSwgb3duZXIsIHJlcG8sIGJyYW5jaCA9ICdkZXZlbG9wJ306IEdpdGh1YkFjdGlvblByb3BzKSB7XG4gICAgICAgIHRoaXMuc291cmNlQWN0aW9uID0gbmV3IEdpdEh1YlNvdXJjZUFjdGlvbih7XG4gICAgICAgICAgICBhY3Rpb25OYW1lOiAnR2l0aHViU291cmNlJyxcbiAgICAgICAgICAgIG91dHB1dDogdGhpcy5zb3VyY2VBcnRpZmFjdCxcbiAgICAgICAgICAgIG9hdXRoVG9rZW46IFNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKHNlY3JldE5hbWUpLFxuICAgICAgICAgICAgb3duZXIsXG4gICAgICAgICAgICByZXBvLFxuICAgICAgICAgICAgYnJhbmNoLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkUHJlRGVwbG95QWN0aW9uKGZ1bjogKHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24pIHtcbiAgICAgICAgdGhpcy5wcmVEZXBsb3lBY3Rpb25zLnB1c2goZnVuKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkU3RhZ2Uoc3RhZ2U6IFN0YWdlKSB7XG4gICAgICAgIHRoaXMuc3RhZ2UgPSBzdGFnZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkQWN0aW9uKGZ1bjogKHBpcGVsaW5lOiBDZGtQaXBlbGluZSwgbmV4dFJ1bk9yZGVyOiBudW1iZXIpID0+IElBY3Rpb24pIHtcbiAgICAgICAgdGhpcy5hY3Rpb25zLnB1c2goZnVuKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkSW52b2tlTGFtYmRhQWN0aW9uKGxhbWJkYTogSUZ1bmN0aW9uLCBwYXJhbXM/OiB7W2tleTogc3RyaW5nXTogdW5rbm93bn0pIHtcblxuICAgICAgICB0aGlzLmFkZEFjdGlvbigoXywgbmV4dFJ1bk9yZGVyKSA9PiBuZXcgTGFtYmRhSW52b2tlQWN0aW9uKHtcbiAgICAgICAgICAgIGxhbWJkYTogbGFtYmRhLFxuICAgICAgICAgICAgYWN0aW9uTmFtZTogYEludm9rZUxhbWJkYWAsXG4gICAgICAgICAgICB1c2VyUGFyYW1ldGVyczogcGFyYW1zLFxuICAgICAgICAgICAgcnVuT3JkZXI6IG5leHRSdW5PcmRlclxuICAgICAgICB9KSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGJ1aWxkKCkge1xuICAgICAgICB0aGlzLnBpcGVsaW5lID0gbmV3IENka1BpcGVsaW5lKHRoaXMuc2NvcGUsIHRoaXMuaWQsIHtcbiAgICAgICAgICAgIHBpcGVsaW5lTmFtZTogdGhpcy5pZCxcbiAgICAgICAgICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdDogdGhpcy5jbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICAgICAgICBzb3VyY2VBY3Rpb246IHRoaXMuc291cmNlQWN0aW9uLFxuICAgICAgICAgICAgc3ludGhBY3Rpb246IHRoaXMuc3ludGhBY3Rpb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLnByZURlcGxveUFjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgcHJlRGVwbG95ID0gdGhpcy5waXBlbGluZS5hZGRTdGFnZSgnUHJlRGVwbG95Jyk7XG4gICAgICAgICAgICB0aGlzLnByZURlcGxveUFjdGlvbnMuZm9yRWFjaChmID0+IHtcbiAgICAgICAgICAgICAgICBwcmVEZXBsb3kuYWRkQWN0aW9ucyhmKHRoaXMucGlwZWxpbmUsIHByZURlcGxveS5uZXh0U2VxdWVudGlhbFJ1bk9yZGVyKCkpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhZ2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY29uc3QgYXBwU3RhZ2UgPSB0aGlzLnBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UodGhpcy5zdGFnZSk7XG4gICAgICAgICAgICBhcHBTdGFnZS5uZXh0U2VxdWVudGlhbFJ1bk9yZGVyKClcbiAgICAgICAgICAgIHRoaXMuYWN0aW9ucy5mb3JFYWNoKGYgPT4ge1xuICAgICAgICAgICAgICAgIGFwcFN0YWdlLmFkZEFjdGlvbnMoZih0aGlzLnBpcGVsaW5lLCBhcHBTdGFnZS5uZXh0U2VxdWVudGlhbFJ1bk9yZGVyKCkpKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG4iXX0=